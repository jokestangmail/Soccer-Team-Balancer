<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Team Balancer" />
<meta name="theme-color" content="#ffffff" />
<title>Team Balancer</title>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg">
<link rel="manifest" href="manifest.json">
<style>
  /* (CSS same as previous approved UI; trimmed comments) */
  :root{--ios-blue:#0A84FF;--bg:#ffffff;--card:#F6F7FA;--border:#E6E8EE;--text:#0B0F1A;--muted:#667085;--green:#34C759;--yellow:#FFCC00;--red:#FF3B30;--shadow:0 6px 18px rgba(10,20,40,0.08);--radius:16px;--maxW:440px}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased}
  .app{max-width:var(--maxW);margin:0 auto;min-height:100vh;padding:12px 14px calc(env(safe-area-inset-bottom) + 118px) 14px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding-top: env(safe-area-inset-top);margin-bottom:10px}
  .logoRow{display:flex;align-items:center;gap:12px;min-width:0}
  .logoBox{width:46px;height:46px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#FDE68A 0%,#FCA5A5 100%);box-shadow:0 6px 18px rgba(10,20,40,0.06);flex:0 0 46px}
  .logoBox svg{width:28px;height:28px;display:block}
  .titleBlock{min-width:0}.title{font-weight:900;font-size:22px;letter-spacing:-0.2px;line-height:1.1}.subtitle{color:var(--muted);font-size:13px;margin-top:3px}
  .pill{flex:0 0 auto;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:900;font-size:13px;min-width:44px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.04)}
  .segWrap{background:#F0F2F6;border:1px solid #E6E8EE;border-radius:14px;padding:4px;display:flex;gap:4px;margin-bottom:12px}
  .seg{flex:1;border:0;border-radius:12px;padding:10px 10px;font-weight:900;font-size:15px;background:transparent;color:var(--muted);cursor:pointer}
  .seg.active{background:#fff;color:var(--text);box-shadow:0 4px 10px rgba(10,20,40,0.06)}
  .sectionCard{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;margin-bottom:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}.fieldLabel{font-size:12px;color:var(--muted);font-weight:800;margin:2px 0 6px}.select,.input{width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-size:16px;outline:none}
  .list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch;padding-right:2px}
  .row{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:14px 14px;box-shadow:0 6px 18px rgba(10,20,40,0.07);display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer}
  .row.alt{background:#fff}.row.selected{background:rgba(10,132,255,0.10);border-color:rgba(10,132,255,0.35)}.left{min-width:0;flex:1}.name{font-size:17px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.meta{font-size:13px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .strength{margin-top:8px;display:flex;align-items:center;gap:10px}.bar{flex:1;height:14px;border-radius:999px;overflow:hidden;background:#E9EDF5;border:1px solid rgba(10,20,40,0.06)}.fill{height:100%;width:0%}.score{font-weight:1000;font-size:14px;min-width:44px;text-align:right;color:#1f2a44}
  .teams{display:flex;flex-direction:column;gap:12px}.teamCard{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:#fff;box-shadow:var(--shadow)}.teamHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;color:#fff;font-weight:1000}.teamHeader .hLeft{display:flex;align-items:center;gap:10px}.teamHeader .hName{font-size:16px;letter-spacing:0.2px}.teamHeader .hStats{font-size:12px;opacity:0.9;text-align:right}.teamBody{padding:10px 12px}.playerLine{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:7px 0;border-bottom:1px solid #F0F2F6}.playerLine:last-child{border-bottom:none}.playerLine .pn{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:62%}.teamStrength{display:flex;align-items:center;gap:10px;min-width:42%;justify-content:flex-end}.teamBar{width:100px;height:12px;border-radius:999px;overflow:hidden;background:#E9EDF5;border:1px solid rgba(10,20,40,0.06)}.teamFill{height:100%;width:0%}.teamScore{min-width:44px;text-align:right;font-weight:1000;font-size:13px;color:#1f2a44}.badge{min-width:44px;text-align:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:1000;color:#1f2a44;font-size:13px}
  .c-red{background:#EB5757}.c-black{background:#111111}.c-blue{background:#2F80ED}.c-white{background:#F0F2F7;color:#111111}.c-white .hStats{opacity:0.75}.shirt svg{display:block}.c-white .shirt svg{filter: drop-shadow(0 1px 1px rgba(0,0,0,0.25))}
  .sticky{position:fixed;left:0;right:0;bottom:0;padding:10px 14px calc(env(safe-area-inset-bottom) + 12px) 14px;background:rgba(255,255,255,0.92);border-top:1px solid var(--border);backdrop-filter:blur(12px)}.stickyInner{max-width:var(--maxW);margin:0 auto}.stickyTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;color:var(--muted);font-weight:800;font-size:13px}.btn{width:100%;padding:16px 16px;border-radius:16px;font-size:17px;font-weight:1000;border:0;cursor:pointer}.btn.primary{background:var(--ios-blue);color:#fff}.btn.primary:disabled{opacity:0.45;cursor:not-allowed}.btnRow2{display:grid;grid-template-columns:1fr 1fr;gap:10px}.btn.secondary{background:#fff;border:1px solid var(--border);color:var(--text)}.btn.outline{background:#fff;border:1px solid rgba(10,132,255,0.35);color:var(--ios-blue)}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);padding:14px;align-items:flex-end;justify-content:center}.sheet{width:100%;max-width:var(--maxW);background:#fff;border-radius:22px;border:1px solid var(--border);box-shadow:0 18px 60px rgba(0,0,0,0.18);padding:14px;margin-bottom:env(safe-area-inset-bottom)}.sheetHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="logoRow">
      <div class="logoBox" aria-hidden="true">
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Team Balancer logo"><defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FDE68A"/><stop offset="100%" stop-color="#FCA5A5"/></linearGradient></defs><rect width="64" height="64" rx="12" fill="url(#g1)"/><g transform="translate(8,8)" fill="#0B0F1A" font-family="Arial" font-weight="700" font-size="28"><text x="6" y="36">TB</text></g></svg>
      </div>
      <div class="titleBlock">
        <div class="title">Team Balancer</div>
        <div class="subtitle">Quick teams • local only</div>
      </div>
    </div>
    <div class="pill" id="dbCount">0</div>
  </div>

  <div class="segWrap">
    <button class="seg active" id="tabGame" type="button">Game</button>
    <button class="seg" id="tabPlayers" type="button">Players</button>
  </div>

  <div id="pageGame">
    <div class="sectionCard">
      <div class="grid2">
        <div>
          <div class="fieldLabel">Game</div>
          <select class="select" id="numGames">
            <option value="1">1 game — 2 teams</option>
            <option value="2">2 games — 4 teams</option>
          </select>
        </div>
        <div>
          <div class="fieldLabel">Search</div>
          <input class="input" id="gameSearch" placeholder="Search players…" />
        </div>
      </div>
    </div>

    <div class="sectionCard">
      <div class="list" id="checklist"></div>
    </div>

    <div id="results"></div>
  </div>

  <div id="pagePlayers" style="display:none;">
    <div class="sectionCard">
      <div class="grid2">
        <div>
          <div class="fieldLabel">Search</div>
          <input class="input" id="playerSearch" placeholder="Search players…" />
        </div>
        <div>
          <div class="fieldLabel">Actions</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <button class="btn primary" id="btnAdd" type="button">Add</button>
            <button class="btn" id="btnReset" type="button">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sectionCard">
      <div class="list" id="playersList"></div>
    </div>

    <div class="sectionCard">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="btn" id="btnExport" type="button">Export JSON</button>
        <button class="btn" id="btnImport" type="button">Import JSON</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <div style="font-size:12px;color:#667085;text-align:center;margin-top:8px">Saved locally in your browser (localStorage)</div>
    </div>
  </div>
</div>

<div class="sticky" id="sticky">
  <div class="stickyInner">
    <div class="stickyTop">
      <div><span id="selCount">0</span> selected</div>
      <div id="objNote"></div>
    </div>

    <div id="stickyActions">
      <button class="btn primary" id="btnGenerate" type="button" disabled>Generate Teams</button>
    </div>
  </div>
</div>

<!-- Modal sheet (full editor included) -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="sheetHeader">
      <div class="shTitle" id="mTitle">Player</div>
      <div class="shBtns">
        <button class="chipBtn" id="mCancel" type="button">Cancel</button>
        <button class="chipBtn primary" id="mSave" type="button">Save</button>
      </div>
    </div>

    <div>
      <div class="fieldLabel">Name</div>
      <input class="input" id="mName" placeholder="Name" />

      <div style="margin-top:10px">
        <div class="fieldLabel">Roles</div>
        <div class="roles">
          <label><input type="checkbox" id="mF"> F</label>
          <label><input type="checkbox" id="mM"> M</label>
          <label><input type="checkbox" id="mD"> D</label>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="fieldLabel">Ratings</div>
        <div class="formGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><input class="input" id="mOverall" type="number" min="1" max="10" placeholder="Overall (1–10)"></div>
          <div><input class="input" id="mPassing" type="number" min="1" max="10" placeholder="Passing (1–10)"></div>
          <div><input class="input" id="mDribbling" type="number" min="1" max="10" placeholder="Dribbling (1–10)"></div>
          <div><input class="input" id="mFinishing" type="number" min="1" max="10" placeholder="Finishing (1–10)"></div>
          <div><input class="input" id="mDefense" type="number" min="1" max="10" placeholder="Defense (1–10)"></div>
          <div><input class="input" id="mSpeed" type="number" min="1" max="10" placeholder="Speed (1–10)"></div>
          <div><input class="input" id="mStamina" type="number" min="1" max="10" placeholder="Stamina (1–10)"></div>
          <div><input class="input" id="mClutch" type="number" min="1" max="5" placeholder="Clutch (1–5)"></div>
          <div><input class="input" id="mConsistency" type="number" min="1" max="5" placeholder="Consistency (1–5)"></div>
          <div><input class="input" id="mLeadership" type="number" min="1" max="5" placeholder="Leadership (1–5)"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="chipBtn danger" id="mDelete" type="button" style="width:100%;">Delete player</button>
      </div>
    </div>
  </div>
</div>

<script>
// Full JS logic (player editor fixed).
(() => {
  const STORAGE_KEY = "ps_balancer_players_v_final";
  const SELECTION_KEY = "ps_balancer_selection_v_final";
  const $ = id => document.getElementById(id);
  const clamp = (n,lo,hi) => Math.max(lo,Math.min(hi,n));
  const uid = ()=> (crypto?.randomUUID?crypto.randomUUID():('id_'+Math.random().toString(16).slice(2)+Date.now()));
  const lower = s => (s||'').toLowerCase();

  function defaultRatings(){return {overall:7,passing:6,dribbling:6,finishing:6,defense:6,speed:6,stamina:6,clutch:3,consistency:3,leadership:3};}
  function sanitize(raw){
    const name = (raw?.name||'').trim();
    const roles = raw?.roles||{};
    const ratings = raw?.ratings||{};
    const p = { id: raw?.id||uid(), name, roles:{F:!!roles.F,M:!!roles.M,D:!!roles.D}, ratings:{
      overall:clamp(Number(ratings.overall||7),1,10), passing:clamp(Number(ratings.passing||6),1,10),
      dribbling:clamp(Number(ratings.dribbling||6),1,10), finishing:clamp(Number(ratings.finishing||6),1,10),
      defense:clamp(Number(ratings.defense||6),1,10), speed:clamp(Number(ratings.speed||6),1,10), stamina:clamp(Number(ratings.stamina||6),1,10),
      clutch:clamp(Number(ratings.clutch||3),1,5), consistency:clamp(Number(ratings.consistency||3),1,5), leadership:clamp(Number(ratings.leadership||3),1,5)
    }};
    if(!p.roles.F && !p.roles.M && !p.roles.D) p.roles.M=true;
    return p;
  }

  const names=["Adnan","Tomek","Mike","Guido","Achkan","Tuto","Carlos","Max C","Kiaan","Matt","Danny","Kadir","Mateo","Hugo","Ciro","Orson","Luismi","Marcelo","Arya","Brandon","Mario","Juan","Max K","Roger","Andy","Devrim","Conrad","Alex"];
  function preload(){ return names.map((n,i)=>{ const r=defaultRatings(); const bump=(i%7)-3; const bump2=((i*3)%5)-2; r.overall = clamp(7 + (bump>=2?1:0) + (bump<=-2?-1:0),1,10); r.passing = clamp(6 + (bump2>0?1:0),1,10); r.dribbling = clamp(6 + (bump2<0?1:0),1,10); r.finishing = clamp(6 + (bump==3?1:0),1,10); r.defense = clamp(6 + (bump==-3?1:0),1,10); r.speed = clamp(6 + (i%4==0?1:0),1,10); r.stamina = clamp(6 + (i%5==0?1:0),1,10); r.clutch = clamp(3 + (i%6==0?1:0),1,5); r.consistency = clamp(3 + (i%8==0?1:0),1,5); r.leadership = clamp(3 + (i%9==0?1:0),1,5); const roles={F:false,M:true,D:false}; if(i%6===0) roles.F=true; if(i%7===0) roles.D=true; if(i%10===0){ roles.M=false; roles.D=true;} if(i%11===0){ roles.M=false; roles.F=true;} return sanitize({id:uid(),name:n,roles,ratings:r}); }); }

  let players = [];
  let selection = new Set();
  let lastSolution = null;

  function load(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw){ players = preload(); save(); } else { try{ players = JSON.parse(raw).map(sanitize); }catch{ players = preload(); save(); } } }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(players)); $('dbCount').textContent = players.length; }

  function loadSelection(){ const raw = localStorage.getItem(SELECTION_KEY); try{ const parsed = JSON.parse(raw||'[]'); if(Array.isArray(parsed)) selection = new Set(parsed.filter(id=> players.some(p=>p.id===id))); }catch{ selection = new Set(); } }
  function saveSelection(){ localStorage.setItem(SELECTION_KEY, JSON.stringify(Array.from(selection))); }

  function computeScore(p){ const r=p.ratings; return (r.overall*3.0)+((r.passing+r.dribbling+r.finishing+r.defense)*1.5)+((r.speed+r.stamina)*1.2)+(r.clutch*1.2)+(r.consistency*1.0)+(r.leadership*1.0); }
  function strengthPct(score){ const max=130; return Math.max(0,Math.min(100,Math.round(100*(score/max)))); }
  function strengthColor(pct){ if(pct>=70) return getComputedStyle(document.documentElement).getPropertyValue('--green').trim(); if(pct>=48) return getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim(); return getComputedStyle(document.documentElement).getPropertyValue('--red').trim(); }

  // simple optimizer (greedy + hillclimb like before)
  function makeTargets(n,teams){ const base=Math.floor(n/teams); const rem=n%teams; return Array.from({length:teams},(_,i)=> base + (i<rem?1:0)); }
  function greedySeed(arr,teams){ const a=arr.slice().sort((x,y)=>y._score-x._score); const targets=makeTargets(a.length,teams); const T=Array.from({length:teams},()=>[]); const totals=Array.from({length:teams},()=>0); for(const p of a){ let best=-1,bv=Infinity; for(let i=0;i<teams;i++){ if(T[i].length>=targets[i]) continue; const proj=(totals[i]+p._score)/(T[i].length+1); if(proj<bv){bv=proj;best=i;} } if(best<0) best=0; T[best].push(p); totals[best]+=p._score; } return T; }
  function randomSeed(arr,teams){ const targets=makeTargets(arr.length,teams); const T=Array.from({length:teams},()=>[]); const counts=Array.from({length:teams},()=>0); const order=arr.slice().sort(()=>Math.random()-0.5); for(const p of order){ const opts=[]; for(let i=0;i<teams;i++) if(counts[i]<targets[i]) opts.push(i); const idx=opts[Math.floor(Math.random()*opts.length)]; T[idx].push(p); counts[idx]++; } return T; }
  function computeStd(vals){ if(vals.length<=1) return 0; const m=vals.reduce((s,x)=>s+x,0)/vals.length; return Math.sqrt(vals.reduce((s,x)=>s+(x-m)*(x-m),0)/vals.length); }
  function computeObjective(teams){ const totals=teams.map(t=>t.reduce((s,p)=>s+p._score,0)); const sizes=teams.map(t=>t.length); const avgs=teams.map((_,i)=>totals[i]/Math.max(1,sizes[i])); const primary=computeStd(avgs); return {objective:primary, primary, rolePenalty:0}; }
  function cloneTeams(t){ return t.map(x=>x.slice()); }
  function trySwap(teams){ const t=teams.length; let a=Math.floor(Math.random()*t); let b=Math.floor(Math.random()*t); if(a===b) b=(b+1)%t; if(teams[a].length===0||teams[b].length===0) return false; const ia=Math.floor(Math.random()*teams[a].length); const ib=Math.floor(Math.random()*teams[b].length); const pa=teams[a][ia], pb=teams[b][ib]; teams[a][ia]=pb; teams[b][ib]=pa; return true; }
  function hillClimb(teams,attempts){ let best=cloneTeams(teams); let bestEval=computeObjective(best); let cur=cloneTeams(best); let curEval=bestEval; let temp=0.06; for(let i=0;i<attempts;i++){ const cand=cloneTeams(cur); if(!trySwap(cand)) continue; const ev=computeObjective(cand); const delta=ev.objective - curEval.objective; const accept = delta<0 || (Math.random() < Math.exp(-delta / Math.max(1e-6,temp))); if(accept){ cur=cand; curEval=ev; if(curEval.objective < bestEval.objective){ best=cloneTeams(cur); bestEval=curEval; } } temp*=0.9992; } return {teams:best, eval:bestEval}; }
  function optimize(selected,teamCount){ const playersArr=selected.map(p=> ({...p, _score: computeScore(p)})); const n=playersArr.length; const small=n<=20; const restarts = small?22:(n<=28?12:8); const attempts = small?3800:(n<=28?2800:2200); let bestTeams=null; let bestEval={objective:Infinity}; for(let r=0;r<restarts;r++){ const base = (r%2===0)? greedySeed(playersArr,teamCount) : randomSeed(playersArr,teamCount); for(let i=0;i<Math.min(30,n);i++) trySwap(base); const res=hillClimb(base,attempts); if(res.eval.objective < bestEval.objective){ bestEval=res.eval; bestTeams=res.teams; } } const totals=bestTeams.map(t=>t.reduce((s,p)=>s+p._score,0)); const avgs=bestTeams.map((t,i)=>totals[i]/Math.max(1,t.length)); return {teams:bestTeams, totals, avgs, eval:bestEval}; }

  function shirtIcon(){ return `<span class="shirt" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M16 3l-1.5 2h-5L8 3 3 6l2.5 4L7 9v12h10V9l1.5 1L21 6l-5-3z"/></svg></span>`; }
  function teamClass(name){ const n=name.toLowerCase(); if(n==='red') return 'c-red'; if(n==='white') return 'c-white'; if(n==='black') return 'c-black'; if(n==='blue') return 'c-blue'; return 'c-blue'; }

  // Rendering
  function renderChecklist(){ const q = (document.getElementById('gameSearch')?.value||'').toLowerCase(); const list = players.slice().sort((a,b)=>a.name.localeCompare(b.name)).filter(p=>!q||p.name.toLowerCase().includes(q)); const wrap = $('checklist'); wrap.innerHTML = ''; list.forEach((p,idx)=>{ const sc = computeScore(p); const pct = strengthPct(sc); const color = strengthColor(pct); const row = document.createElement('div'); row.className = 'row ' + (idx%2===1?'alt':''); if(selection.has(p.id)) row.classList.add('selected'); row.addEventListener('click', ()=>{ if(selection.has(p.id)) selection.delete(p.id); else selection.add(p.id); saveSelection(); lastSolution=null; renderResults(null); renderChecklist(); updateSticky(); }); const left = document.createElement('div'); left.className='left'; const name = document.createElement('div'); name.className='name'; name.textContent = p.name; const roles = `${p.roles.F? 'F':''}${p.roles.M? 'M':''}${p.roles.D? 'D':''}` || '—'; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `Overall ${p.ratings.overall} • ${roles}`; const strength = document.createElement('div'); strength.className='strength'; const bar = document.createElement('div'); bar.className='bar'; const fill = document.createElement('div'); fill.className='fill'; fill.style.width = pct + '%'; fill.style.background = color; bar.appendChild(fill); const score = document.createElement('div'); score.className='score'; score.textContent = Math.round(sc).toString(); strength.appendChild(bar); strength.appendChild(score); left.appendChild(name); left.appendChild(meta); left.appendChild(strength); row.appendChild(left); wrap.appendChild(row); }); }

  function renderResults(sol){ const wrap=$('results'); wrap.innerHTML=''; if(!sol) return; const names = sol.teams.length===2?['Red','White']:['Red','White','Black','Blue']; const teamsDiv=document.createElement('div'); teamsDiv.className='teams'; sol.teams.forEach((team,i)=>{ const teamName=names[i]; const t=document.createElement('div'); t.className='teamCard'; const header=document.createElement('div'); header.className='teamHeader ' + (teamName.toLowerCase()==='white'?'c-white': 'c-' + teamName.toLowerCase()); const left=document.createElement('div'); left.className='hLeft'; left.innerHTML = shirtIcon() + `<div class="hName">${teamName.toUpperCase()}</div>`; const right=document.createElement('div'); right.className='hStats'; right.innerHTML = `Total ${sol.totals[i].toFixed(0)}<br/>Avg ${sol.avgs[i].toFixed(2)}`; header.appendChild(left); header.appendChild(right); const body=document.createElement('div'); body.className='teamBody'; team.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{ const line=document.createElement('div'); line.className='playerLine'; const nm=document.createElement('div'); nm.className='pn'; nm.textContent=p.name; const pct=strengthPct(p._score); const color=strengthColor(pct); const rightDiv=document.createElement('div'); rightDiv.className='teamStrength'; const bar=document.createElement('div'); bar.className='teamBar'; const fill=document.createElement('div'); fill.className='teamFill'; fill.style.width = pct + '%'; fill.style.background = color; bar.appendChild(fill); const sc=document.createElement('div'); sc.className='teamScore'; sc.textContent = Math.round(p._score).toString(); rightDiv.appendChild(bar); rightDiv.appendChild(sc); line.appendChild(nm); line.appendChild(rightDiv); body.appendChild(line); }); t.appendChild(header); t.appendChild(body); teamsDiv.appendChild(t); }); wrap.appendChild(teamsDiv); }

  function updateSticky(){ $('selCount').textContent = String(selection.size); const can = selection.size>=2; const box = $('stickyActions'); box.innerHTML = ''; if(lastSolution){ const row=document.createElement('div'); row.className='btnRow2'; const regen=document.createElement('button'); regen.className='btn outline'; regen.textContent='Regenerate'; regen.addEventListener('click', ()=>runGenerate(true)); const clear=document.createElement('button'); clear.className='btn secondary'; clear.textContent='Clear'; clear.addEventListener('click', clearSelection); row.appendChild(regen); row.appendChild(clear); box.appendChild(row); } else { const gen=document.createElement('button'); gen.className='btn primary'; gen.textContent='Generate Teams'; gen.disabled = !can; gen.addEventListener('click', ()=>runGenerate(false)); box.appendChild(gen); } }

  function clearSelection(){ selection.clear(); saveSelection(); lastSolution=null; renderResults(null); renderChecklist(); updateSticky(); }
  function saveSelection(){ localStorage.setItem(SELECTION_KEY, JSON.stringify(Array.from(selection))); }

  function runGenerate(isRegen){ const sel = players.filter(p=>selection.has(p.id)); const games = Number(document.getElementById('numGames').value)||1; const teamCount = games===1?2:4; if(sel.length < teamCount){ alert('Select at least ' + teamCount + ' players.'); return; } const sol = optimize(sel, teamCount); lastSolution = sol; renderResults(sol); updateSticky(); setTimeout(()=> document.getElementById('results').scrollIntoView({behavior:'smooth', block:'start'}),60); }

  // modal editor functions
  let editingId = null;
  function openModal(id){ editingId = id || null; const p = id ? players.find(x=>x.id===id) : null; const data = p ? sanitize(p) : sanitize({id:null, name:'', roles:{M:true}, ratings:defaultRatings()}); $('mTitle').textContent = id ? 'Edit Player' : 'Add Player'; $('mName').value = data.name || ''; $('mF').checked = !!data.roles.F; $('mM').checked = !!data.roles.M; $('mD').checked = !!data.roles.D; $('mOverall').value = data.ratings.overall; $('mPassing').value = data.ratings.passing; $('mDribbling').value = data.ratings.dribbling; $('mFinishing').value = data.ratings.finishing; $('mDefense').value = data.ratings.defense; $('mSpeed').value = data.ratings.speed; $('mStamina').value = data.ratings.stamina; $('mClutch').value = data.ratings.clutch; $('mConsistency').value = data.ratings.consistency; $('mLeadership').value = data.ratings.leadership; $('mDelete').style.display = id ? '' : 'none'; $('modal').style.display = 'flex'; setTimeout(()=> $('mName').focus(),50); }
  function closeModal(){ $('modal').style.display='none'; editingId = null; }

  function upsertFromModal(){ const name = ($('mName').value||'').trim(); if(!name){ alert('Name required'); return; } const roles = {F: $('mF').checked, M: $('mM').checked, D: $('mD').checked}; const ratings = { overall: clamp(Number($('mOverall').value||7),1,10), passing: clamp(Number($('mPassing').value||6),1,10), dribbling: clamp(Number($('mDribbling').value||6),1,10), finishing: clamp(Number($('mFinishing').value||6),1,10), defense: clamp(Number($('mDefense').value||6),1,10), speed: clamp(Number($('mSpeed').value||6),1,10), stamina: clamp(Number($('mStamina').value||6),1,10), clutch: clamp(Number($('mClutch').value||3),1,5), consistency: clamp(Number($('mConsistency').value||3),1,5), leadership: clamp(Number($('mLeadership').value||3),1,5) }; const id = editingId || uid(); const p = sanitize({ id, name, roles, ratings }); const idx = players.findIndex(x=>x.id===id); if(idx>=0) players[idx] = p; else players.push(p); save(); renderPlayersPage(); renderChecklist(); updateSticky(); closeModal(); }

  function deleteFromModal(){ if(!editingId) return; const p = players.find(x=>x.id===editingId); if(!p) return; if(!confirm('Delete ' + p.name + '?')) return; players = players.filter(x=>x.id !== editingId); selection.delete(editingId); save(); saveSelection(); lastSolution = null; renderResults(null); renderPlayersPage(); renderChecklist(); updateSticky(); closeModal(); }

  // players page actions
  function renderPlayersPage(){ const q = (document.getElementById('playerSearch')?.value||'').toLowerCase(); const wrap = $('playersList'); wrap.innerHTML = ''; players.slice().sort((a,b)=>a.name.localeCompare(b.name)).filter(p=>!q||p.name.toLowerCase().includes(q)).forEach((p,idx)=>{ const sc = computeScore(p); const pct = strengthPct(sc); const color = strengthColor(pct); const row = document.createElement('div'); row.className = 'row ' + (idx%2===1?'alt':''); row.addEventListener('click', ()=>openModal(p.id)); const left = document.createElement('div'); left.className='left'; const name = document.createElement('div'); name.className='name'; name.textContent = p.name; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = 'Overall ' + p.ratings.overall; const strength = document.createElement('div'); strength.className='strength'; const bar = document.createElement('div'); bar.className='bar'; const fill = document.createElement('div'); fill.className='fill'; fill.style.width = pct + '%'; fill.style.background = color; bar.appendChild(fill); const score = document.createElement('div'); score.className='score'; score.textContent = Math.round(sc).toString(); strength.appendChild(bar); strength.appendChild(score); left.appendChild(name); left.appendChild(meta); left.appendChild(strength); row.appendChild(left); wrap.appendChild(row); }); }

  // export/import
  function exportJSON(){ const blob = new Blob([JSON.stringify(players,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='team_balancer_players.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  function importJSONFile(file){ const reader = new FileReader(); reader.onload = ()=>{ try{ const parsed = JSON.parse(String(reader.result||'')); if(!Array.isArray(parsed)) throw new Error('bad'); players = parsed.map(sanitize).filter(p=>p.name); save(); loadSelection(); saveSelection(); lastSolution=null; renderResults(null); renderPlayersPage(); renderChecklist(); updateSticky(); alert('Import successful'); }catch{ alert('Import failed: file must be a JSON array of players'); } }; reader.readAsText(file); }

  // wire up basic UI
  document.getElementById('tabGame').addEventListener('click', ()=>{ document.getElementById('pageGame').style.display=''; document.getElementById('pagePlayers').style.display='none'; document.getElementById('tabGame').classList.add('active'); document.getElementById('tabPlayers').classList.remove('active'); });
  document.getElementById('tabPlayers').addEventListener('click', ()=>{ document.getElementById('pageGame').style.display='none'; document.getElementById('pagePlayers').style.display=''; document.getElementById('tabGame').classList.remove('active'); document.getElementById('tabPlayers').classList.add('active'); });

  document.getElementById('gameSearch').addEventListener('input', renderChecklist);
  document.getElementById('playerSearch').addEventListener('input', renderPlayersPage);
  document.getElementById('numGames').addEventListener('change', ()=>{ lastSolution=null; renderResults(null); updateSticky(); });

  document.getElementById('btnAdd').addEventListener('click', ()=>openModal(null));
  document.getElementById('btnReset').addEventListener('click', ()=>{ if(!confirm('Reset players to preload defaults?')) return; players = preload(); selection.clear(); save(); saveSelection(); lastSolution=null; renderResults(null); renderPlayersPage(); renderChecklist(); updateSticky(); });

  document.getElementById('btnExport').addEventListener('click', exportJSON);
  document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if(f) importJSONFile(f); document.getElementById('importFile').value=''; });

  document.getElementById('mCancel').addEventListener('click', closeModal);
  document.getElementById('mSave').addEventListener('click', upsertFromModal);
  document.getElementById('mDelete').addEventListener('click', deleteFromModal);
  document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

  // init
  load(); loadSelection(); save(); renderChecklist(); renderPlayersPage(); updateSticky();
})();
</script>
</body>
</html>
